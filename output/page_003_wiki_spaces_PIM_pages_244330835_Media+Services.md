# Media Services

The media services provide APIs to retrieve images and files (collectively called **Binaries**) from Perfion. They are hosted on a Microsoft IIS Web Server and designed with a pull-strategy for linear scalability.

## Overview of Media Services

| **Service Name**       | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **File**               | Serves Perfion file and image type binaries without image processing. Delivers original file content, either inline (e.g., in browser) or as an attachment (forces download). Requested files are cached for faster subsequent access.                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Image**              | Serves Perfion file and image type binaries with optional image processing (only for image type binaries). File type binaries are served without processing. Supports inline display or download. Processed images are cached. Can add watermarks based on configuration and request parameters. See [Image Watermarking](#image-watermarking).                                                                                                                                                                                                                                                                                                         |
| **Watermarked Image**  | Similar to Image service but **always** adds watermark and **only** serves image type binaries (file type binaries are not supported).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **UncachedImage**      | Similar to Image service but **does not** use precached renditions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

**Note:** Inline rendering depends on the client application (usually a browser). Most browsers render images inline, but complex formats like TIFF may not be supported. Some file formats (text, HTML, XML) may also render inline.

---

## Media Service Configuration

Media services parameters can be configured via:

- **MediaService.Config** (recommended)
- **Web.Config** (legacy/backward compatibility)

If `MediaService.Config` exists, it overrides `Web.Config`.

### Configuration Parameters

| **Parameter Name**             | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ID**                        | Media service ID (GUID). Optional for database-based, **required** for Perfion Cloud-based. Web.Config key: `Perfion.MediaServiceId`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Name**                      | Media service name. Optional, used only with Perfion Cloud-based. Web.Config key: `Perfion.MediaServiceName`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **IsActive**                  | Boolean, enables/disables the service. Default: `true`. Web.Config key: `Perfion.IsActive`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **PerfionDBConnectionString** | Connection string to Perfion database (only for database-based). Leave blank for Cloud-based. In Web.Config: under `<connectionStrings>` with name `perfionConn`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **StorageServiceUrl**         | URL of Perfion Storage Service (Cloud-based only). Used if no DB connection string. Web.Config key: `Perfion.StorageServiceUrl`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **StorageServiceKey**         | API key for Perfion Storage Service (Cloud-based only). Used if no DB connection string. Web.Config key: `Perfion.StorageServiceKey`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **WatermarkRange**            | Controls watermark application: <br>0 (default) = disabled <br>1 = always apply <br>>1 = apply if image dimension exceeds value (pixels). Optional. Web.Config key: `Perfion.WatermarkRange`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **WatermarkPath**             | Relative path to watermark image. Optional. If missing or invalid, watermarking is disabled. Required for Watermarked Image service. Web.Config key: `Perfion.Watermark`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **NoImageImagePath**          | Path to image shown when requested image not found. Optional. Defaults to built-in image. Relative path. Web.Config key: `Perfion.NoImageFoundImage`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **HttpCacheability**          | Controls HTTP cache headers. Values: `Server` (default), `NoCache`, `Private`, `Public`, `ServerAndNoCache`, `ServerAndPrivate`. Optional. Web.Config key: `Perfion.FileHttpCacheability` [See .NET docs](https://docs.microsoft.com/en-us/dotnet/api/system.web.httpcacheability?view=netframework-4.8)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ReadTimeoutInMs**           | Timeout (ms) when reading cache files. Default: 5000. Optional. Web.Config key: `Perfion.BinaryCache_ReaderTimeOut`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **WriteTimeoutInMs**          | Timeout (ms) when writing cache files. Default: 5000. Optional. Web.Config key: `Perfion.BinaryCache_WriteTimeOut`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **MinimumDiskSpaceInMb**      | Minimum disk space (MB) before service errors out. Default: 100. Optional. Web.Config key: `Perfion.DiskSpaceLimitInMb`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **CacheRecheckDelayInMs**     | HTTP cache expiration time (ms). Default: 300000 (5 min). Optional. Web.Config key: `Perfion.BinaryCache_CachingTime`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **CacheRelativePath**         | Relative path for cache and logs. Default: `Cache`. Optional. Web.Config key: `Perfion.CacheStoragePath`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **LogLevel**                  | Logging level: `Error` (default), `Warning`, `Info`, `Debug`. Optional. Web.Config key: `Perfion.LogLevel`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

---

## Media Service Types

| **Type**                                   | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Database based**                         | Default type. Uses a single Perfion database as source. Caches binaries on local server disk. If Perfion Cloud Storage is enabled, it can serve binaries stored in the cloud **only if** they are known to the connected database. Cache is local filesystem.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Perfion Cloud based – via Storage Service** | Used when Perfion Cloud Storage is enabled and binaries are migrated to cloud. No DB connection string; instead, uses `StorageServiceUrl` and `StorageServiceKey`. Cache is in Perfion Cloud storage. Can serve binaries from multiple databases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Perfion Cloud based – special version**  | Built-in to Perfion Storage Service, hosted/administered by Perfion. Similar to above but managed by Perfion.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

---

## Using Media Services

Binaries are accessed via URLs with specific formats.

### URL Formats

```
http://<ServiceHostName>/Perfion/<ServiceDesignation1>?id=<BinaryID>[&<ServiceParameters>]
http://<ServiceHostName>/<ServiceDesignation2>/<BinaryID>/<FileName>[?<ServiceParameters>]
```

### Components

- **ServiceHostName**: Server hosting media services
- **ServiceDesignation1** (file name):
  - `File.aspx` (File service)
  - `Image.aspx` (Image service)
  - `ImageW.aspx` (Watermarked Image service)
  - `ImageUncached.aspx` (Uncached Image service)
- **ServiceDesignation2** (path segment):
  - `file`
  - `image`
  - `wimage`
  - `uimage`
- **BinaryID**: GUID of the binary
- **FileName**: Arbitrary filename with extension (not used for lookup)
- **ServiceParameters**: Optional URL parameters

### Examples

```html
<img src="http://ServiceHostName/Perfion/Image.aspx?id=BinaryID" />
<img src="http://ServiceHostName/image/BinaryID/MyImage.jpg" />

<a href="http://ServiceHostName/Perfion/File.aspx?id=BinaryID">Download</a>
<a href="http://ServiceHostName/file/BinaryID/MyFile.zip">Download</a>
```

---

## Media Services URL Parameters

### General Format

```
?id=<BinaryID>&<Parameter1>=<Value1>&<Parameter2>=<Value2>...
```

Example: Resize image to 200x200 pixels and convert to JPG

```
http://ServiceHostName/Perfion/Image.aspx?id=FileId&size=200x200&format=jpg
http://ServiceHostName/image/FileId/MyImage.jpg?size=200x200&format=jpg
```

**Note:** `id` is mandatory; others are optional.

### Common Parameters (all services)

| **Parameter** | **Description**                                                                                                                                                                                                                                         |
|---------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`          | GUID of the binary (mandatory). Obtainable via Perfion API queries.                                                                                                                                                                                    |
| `action`      | If set to `save`, forces download (attachment) instead of inline display.                                                                                                                                                                              |
| `mime`        | Override MIME type of response. E.g., `image/jpeg`, `application/zip`.                                                                                                                                                                                 |
| `delete`      | If `1`, clears cached version before serving fresh copy.                                                                                                                                                                                               |
| `filename`    | Override filename in response.                                                                                                                                                                                                                         |
| `debug`       | If `1`, forces logging of request.                                                                                                                                                                                                                     |

### File Service Parameters

- No special parameters beyond common ones.

### Image Service Parameters

| **Parameter**     | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `format`          | Output image format. Supported: BMP, GIF, JPG/JPEG, PNG, TIFF/TIF, EPS, PSD, PDF, SVG, WEBP, AVIF.                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `dpi`             | Scale image to specified DPI. Cannot be combined with `size` or `fit`. Decimal allowed.                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `size`            | Resize to `<width>x<height>` pixels (integers). How resizing is done depends on `fit`.                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `fit`             | Controls resizing behavior with `size`: <br> - `fit` (default): scale to fit, keep aspect ratio <br> - `exact`: scale exactly, may distort <br> - `crop`: scale and crop to fit <br> - `smart`: mix of crop and scale <br> - `aspectratio`: scale to fit, fill remaining with `canvascolor`                                                                                                                                                                                                                              |
| `canvascolor`     | Background color (hex RGB or ARGB) used with `fit=aspectratio`. E.g., `ccff33`.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `backgroundcolor` | Color to fill transparent parts when output format doesn't support transparency. Hex RGB or ARGB.                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `quality`         | Compression quality (1-100). Default 90. Applies to JPG and PNG.                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `tiffcomp`        | TIFF compression: `LZW` (default), `ZIP`, `None`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `colorprof`       | Color profile: `Original`, `CMYK`, `sRGB`, `AdobeRGB1998`, `ProPhoto`.                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `usepoi`          | Use Point-of-Interest (POI) metadata for cropping. `0` (default) or `1`. Only with `size` and `fit=crop` or `smart`.                                                                                                                                                                                                                                                                                                                                                                                                     |
| `poi`             | Custom POI override, format `<X>x<Y>` (%). E.g., `50x50` for center. Only if `usepoi=1`.                                                                                                                                                                                                                                                                                                                                                                                                                                |

---

## Image Watermarking

- Enabled by configuring `WatermarkPath` and `WatermarkRange`.
- Watermark is applied as an overlay in the lower-left corner.
- If watermark image is larger than target, it is scaled down to fit.
- To control watermark size (e.g., max 75%), create watermark image on a larger transparent canvas.
- Watermark can have transparency for subtlety.

**Notes:**

- Watermarking **not supported** on vector formats (SVG, EPS). These are rasterized before watermarking.
- Watermarked Image service **only** serves image type binaries, not file type binaries.

---

## Media Services Functionality Comparison

| **Service**                     | **File** | **Image** | **ImageW** | **ImageUncached** |
|--------------------------------|----------|-----------|------------|-------------------|
| File type binaries             | Yes      | Yes       | No         | Yes               |
| File type binaries (image fmt) | Yes      | Yes       | No         | Yes               |
| Image type binaries            | Yes      | Yes       | Yes        | Yes               |
| Process image (file type)      | No       | No        | No         | No                |
| Process image (image type)     | Yes      | Yes       | Yes        | Yes               |
| Watermark image                | No       | Yes       | Yes        | Yes               |

---

## HTTP GET vs. HTTP HEAD Requests

- **GET**: Returns full response including binary data.
- **HEAD**: Returns headers only, no content.